# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Kitsune is an AI agent microservice with a React frontend. FastAPI backend with PydanticAI agent (Vercel AI SDK protocol) and per-user Docker-sandboxed marimo notebooks. Served via Uvicorn on port 8010.

## Tech Stack

- Python 3.14, managed with **uv**
- **FastAPI** as web framework
- **PydanticAI** + **Vercel AI SDK** for agent protocol ([Documentation](https://ai.pydantic.dev/llms.txt))
- **Marimo** for interactive notebooks (edit mode, per-user Docker containers)
- **Docker** SDK for Python — sandbox container lifecycle
- **Logfire** for tracing/observability
- **React 19** + **Vite 6** + **Tailwind v4** — static SPA served by FastAPI
- **@ai-sdk/react** `useChat` hook for streaming chat

## Commands

```bash
uv sync                                          # Install Python dependencies
uv run main.py                                   # Run FastAPI on localhost:8010 (auto-reload)
docker build -t kitsune-marimo-sandbox docker/marimo/   # Build sandbox image
cd frontend && npm install                       # Install frontend dependencies
cd frontend && npm run dev                       # Vite dev server on :5173 (proxies API to :8010)
cd frontend && npm run build                     # Build frontend → static/ (served by FastAPI)

# Docker (production)
docker compose -f docker/docker-compose.yml --profile tools build   # Build both images (kitsune + marimo-sandbox)
docker compose -f docker/docker-compose.yml up                      # Run kitsune server
docker compose -f docker/docker-compose.yml up --build              # Rebuild kitsune and run
```

## Structure

```
main.py                         # FastAPI app: /chat endpoint, sandbox lifecycle, health check, static files
pyproject.toml                  # Python deps (fastapi, pydantic-ai, docker)
docker/
├── docker-compose.yml          # Production compose (build context: project root)
├── kitsune/Dockerfile          # Server image: multi-stage Node (frontend) + Python 3.14-slim
└── marimo/Dockerfile           # Sandbox image: python:3.14-slim + marimo + data science deps
.dockerignore                   # Excludes .venv, node_modules, static, data from build context
static/                         # Built frontend (gitignored, generated by npm run build)
frontend/
├── package.json                # React 19, @ai-sdk/react, Vite, Tailwind v4
├── vite.config.ts              # Tailwind plugin, outDir: ../static, dev proxy → :8010
├── tsconfig.json
├── components.json             # shadcn config
└── src/
    ├── main.tsx
    ├── App.tsx                 # Layout: <Sidebar> + <Header> + <ChatPanel> + <NotebookPanel>
    ├── index.css               # @import "tailwindcss", CSS variables
    ├── hooks/
    │   └── useSession.ts       # Stable localStorage UUID session ID
    └── components/
        ├── Sidebar.tsx         # 56px icon sidebar
        ├── Header.tsx          # Logo + amber→rose gradient strip
        ├── ChatPanel.tsx       # useChat integration, 40% width
        └── NotebookPanel.tsx   # Marimo iframe + notebook tabs, 60% width
kitsune/
├── config.py                   # Environment config (incl. sandbox settings)
├── models.py                   # Pydantic models (User, Message, Session)
├── utils.py                    # Utility functions
├── logging.py                  # JSON rotating file logger
├── agents/
│   └── marimo.py               # Marimo agent: deps, notebook tools, cell builder
└── services/
    └── sandbox.py              # SandboxManager: Docker container lifecycle per session
notebooks/                      # Template marimo .py notebooks (seeded into user dirs)
data/notebooks/{session_id}/    # Per-user notebook storage (gitignored)
```

## Architecture

- **Vercel AI protocol**: Backend uses `VercelAIAdapter.dispatch_request()` on `POST /chat`
- Frontend (`useChat` hook) streams responses via the `/chat` endpoint
- **Sandbox isolation**: Each user session gets a dedicated Docker container running `marimo edit` on port 2718 (mapped to host port 9100–9200)
- `GET /notebooks/{session_id}` — returns marimo edit URL for iframe embedding
- `GET /notebooks` — lists notebooks scoped to session (falls back to templates)
- `SandboxManager` handles container create/destroy, port allocation, and stale cleanup (30 min timeout)
- Session ID passed via `x-session-id` header (auth TBD); frontend uses stable localStorage UUID
- **Static files**: FastAPI mounts `static/` at `/` — SPA fallback via `html=True`
- **Health check**: `GET /health` for container orchestration
